:root{
  --ai:#B5B1AB;
  --notes:#F5F2E9;
  --notes-text:#123E2A;
  --topbar:#716868;
  --page:#D9D6CD;
  --scroll:#9A9792;
  --text:#463F3F;
  --accent:#00361D;

  --ink-highlighter: rgba(15,53,36,.25);
  --ink-pen: #123E2A;
}

/* Base */
*,
*::before,
*::after{ box-sizing:border-box; }
html,body{ height:100%; }
body{ margin:0; font-family:"Times New Roman", Tinos, serif; color:var(--text); background:var(--page); }

/* Exit (50x50), no shadow) */
.exit-btn-fixed{
  position:fixed; z-index:1001; top:8px; left:8px;
  width:50px; height:50px; display:inline-flex; align-items:center; justify-content:center;
  border-radius:50%; background:transparent; box-shadow:none; border:none;
}
.exit-btn-fixed img{ width:100%; height:100%; object-fit:contain; display:block; }

/* Frame: 3 cols, short top bar */
.reader-shell{
  min-height:100vh;
  display:grid;
  grid-template-columns: 1fr 2fr 1fr;
  grid-template-rows: 46px 1fr;
}
.topbar{
  grid-column:2; grid-row:1;
  height:46px; background:var(--topbar); color:#fff;
  display:grid; grid-template-columns: 1fr minmax(720px, 1000px) 1fr; align-items:center;
}
.topbar .bar-inner{
  grid-column:2; height:100%;
  display:flex; align-items:center; gap:10px; justify-content:flex-start;
}

/* Tool tokens */
.tool-btn{
  width:40px; height:40px;
  display:inline-flex; align-items:center; justify-content:center;
  border-radius:50%;
  background:#BEB8B2;
  border:2px solid #463F3F;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
  padding:0; cursor:pointer; user-select:none;
}
.tool-btn img{ width:110%; height:110%; object-fit:contain; display:block; }
.tool-btn.active{ outline:3px solid rgba(0,54,29,.35); outline-offset:2px; }

/* Cursors when tools active */
.pdf-scroll.textbox-mode,
.pdf-scroll.highlight-mode,
.pdf-scroll.draw-mode{ cursor:crosshair; }

/* Keep children on main grid */
.layout{ display:contents; }

/* Ask AI pane */
.askai{
  grid-column:1; grid-row:1 / span 2;
  background:var(--ai);
  padding:12px; display:flex; flex-direction:column; min-height:0; position:relative;
}
.ai-out{
  flex:1; background:transparent; margin-top:50px; padding:0 12px 12px 14px; border:0; white-space:pre-wrap; overflow:auto;
}
.ai-form{ position:absolute; left:16px; bottom:16px; margin:0; }
.ai-input{ position:relative; width:300px; height:36px; }
.ai-input input{
  position:absolute; inset:0;
  background:#D9D6CD; border:1px solid #cfc6b8; border-radius:0;
  padding:6px 44px 6px 12px;
  font-family:"Tinos","Times New Roman",serif; font-size:20px; color:#0F3524;
}
.ai-input input::placeholder{ font-family:"Tinos","Times New Roman",serif; font-size:20px; color:#0F3524; opacity:.5; }
.ai-input .icon-btn{
  position:absolute; right:8px; top:50%; transform:translateY(-50%);
  width:28px; height:28px; border:0; background:transparent; padding:0; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
}
.ai-input .icon-btn img{ width:100%; height:100%; display:block; }

/* Middle reader */
.book-area{ grid-column:2; grid-row:2; display:flex; flex-direction:column; min-width:0; background:transparent; }
.pdf-scroll{
  flex:1;
  min-height:60vh;
  max-height:calc(100vh - 46px - 58px);
  overflow-y:auto;
  overflow-x:hidden;      /* remove horizontal scrollbar */
  padding:12px 0;
}
.pdf-pages{ width:100%; }
.pdf-scroll::-webkit-scrollbar{ width:10px; }
.pdf-scroll::-webkit-scrollbar-thumb{ background:var(--scroll); border-radius:6px; }

/* PDF page card */
.pdf-page{
  position:relative;
  width:min(95%, 840px);
  margin:12px auto;
  background:#fff;
  border-radius:4px;
  box-shadow:0 2px 8px rgba(0,0,0,.12);
  overflow:visible;
}
/* Overlays */
.pdf-page .overlay-layer{ position:absolute; inset:0; pointer-events:none; z-index:2; }
.pdf-page .draw-canvas{ position:absolute; inset:0; pointer-events:auto; z-index:2; }

/* --- Text boxes (single, non-duplicated definition) --- */
.pdf-page .textbox{
  position:absolute;
  left:0; top:0;
  min-width:120px; min-height:60px;
  background:rgba(255, 251, 230, 0.72);
  border:1px solid rgba(0,0,0,.25);
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.12);
  z-index:3;
  display:flex; flex-direction:column;
  pointer-events:auto;
  overflow:hidden; /* keep content + handle inside rounded corners */
}
.pdf-page .textbox .tb-handle{
  height:18px;
  background:rgba(0,0,0,.08);
  border-bottom:1px solid rgba(0,0,0,.15);
  cursor:grab;
  flex:0 0 auto;
  user-select:none;
}
.pdf-page .textbox.dragging .tb-handle{
  cursor:grabbing;
  background:rgba(0,0,0,.14);
}
.pdf-page .textbox .tb-content{
  padding:6px 8px;
  font-family:"Tinos","Times New Roman",serif;
  font-size:16px; line-height:1.35; color:#463F3F;
  outline:none;
  overflow:auto;
  white-space:pre-wrap;
  word-break:break-word;
  max-height:calc(100% - 18px);
}

.progress-bar{
  margin:10px auto 0;
  display:flex; gap:12px; align-items:center; justify-content:center;
  padding:4px 8px; font-size:13px; flex-wrap:wrap;
}
.progress-bar .controls-left{ display:flex; gap:8px; align-items:center; }
.btn-ghost{
  padding:6px 10px; font-size:13px; border-radius:8px;
  border:1px solid #cfc6b8; background:transparent; cursor:pointer; color:#463F3F;
}
.btn-ghost:hover{ background:rgba(0,0,0,.04); }
.progress-bar input[type="number"]{
  height:28px; width:72px; padding:4px 6px;
  font-size:14px; border-radius:6px; border:1px solid rgba(0,0,0,.15);
  background:#fff;
}
.btn-save{
  padding:6px 10px; font-size:13px; border-radius:8px;
  border:1px solid rgba(0,0,0,.15); background:#fff; cursor:pointer;
}

/* Notes pane */
.notes{
  grid-column:3; grid-row:1 / span 2;
  background:var(--notes); color:var(--notes-text);
  padding:0; display:flex; flex-direction:column; overflow:hidden;
}
.notes.expanded{ grid-column:2 / span 2; grid-row:1 / span 2; }
.notes-page-num{
  text-align:center; font-family:"Tinos","Times New Roman",serif; font-size:18px; line-height:1; color:#9A9792;
  padding:10px 0 6px; position:sticky; top:0; background:var(--notes); z-index:1;
}
.note-form{ padding:18px 20px 14px; display:flex; flex-direction:column; gap:12px; }
.note-form .row{ display:flex; gap:8px; flex-wrap:wrap; }
.note-title{
  border:0; outline:none; background:transparent;
  font-family:"Tinos","Times New Roman",serif; font-weight:700; font-size:44px; line-height:1.1; color:#0F3524; padding:4px 0 2px;
}
.note-title::placeholder{ color:#0F3524; opacity:1; }
.note-page{
  width:90px; border:0; outline:none; background:transparent;
  font-family:"Tinos","Times New Roman",serif; font-size:18px; color:var(--notes-text);
  border-bottom:1px dashed rgba(0,0,0,.15);
}
.note-text{
  border:0; outline:none; resize:vertical;
  min-height:calc(100vh - 220px);
  background:transparent;
  font-family:"Tinos","Times New Roman",serif;
  font-size:20px; line-height:1.6;
  color:var(--notes-text); padding:0; white-space:pre-wrap;
}
.note-text::placeholder{ color:var(--notes-text); opacity:1; }

/* Floating page HUD */
.page-hud{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  padding:6px 10px; border-radius:8px;
  background:rgba(0,0,0,.6); color:#fff;
  font-family:"Times New Roman", Tinos, serif; font-size:14px; line-height:1;
  z-index:1000; pointer-events:none;
}

/* Responsive */
@media (max-width: 980px){
  .reader-shell{
    grid-template-columns: 1fr; grid-template-rows: 46px auto auto;
  }
  .topbar{ grid-column:1; }
  .askai{ grid-column:1; grid-row:auto; min-height:160px; }
  .book-area{ grid-column:1; }
  .notes{ grid-column:1; }
  .notes.expanded{ grid-column:1; }
  .page-hud{ bottom:10px; }
  .note-title{ font-size:34px; }
}
@media (max-width: 520px){
  .tool-btn{ width:36px; height:36px; }
  .ai-input{ width:220px; }
  .note-title{ font-size:28px; }
  .note-text{ font-size:18px; }
}